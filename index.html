<html><head>
  <title>A sonnet</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href='http://fonts.googleapis.com/css?family=Lusitana:400,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
body { 
    margin: 5em 7em;
    font-family: 'Lusitana', Georgia, serif;
    font-size: 110%;
}
.footer {
    font-size: smaller;
}
  </style>

  <script src="seedrandom.js"></script>
  <script type="text/javascript">
'use strict';

window.onload = function() {

function randomTitle() {
    Math.seedrandom(new Date().getTime());
    return 'Sonnet ' + numberWithCommas(pickInt(Math.pow(2, 48)));
}

// http://stackoverflow.com/questions/2901102/how-to-print-number-with-commas-as-thousands-separators-in-javascript
function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function pushTitle(text) {
    location.hash = 'title=' + text;
    setTitle(text);
}

function getTitle() {
    return location.hash.toString().substring(1).replace(/^title=/, '');
}

window.onhashchange = function() {
    setTitle(getTitle());
};

function setTitle(text) {
    title.replaceChild(document.createTextNode(dumbQuote(text)),
                       title.firstChild);
    Math.seedrandom(text);
    invokeTheMuse(text);
}

var updateIntervalId;
var verseCache = {};

function invokeTheMuse(title) {
    if (updateIntervalId)
        clearInterval(updateIntervalId);
    var cached = verseCache['title=' + title];
    if (cached) {
        verse.innerHTML = cached;
        return;
    }
    function updateVerse() {
        verse.innerHTML = emit(states);
    }
    updateIntervalId = setInterval(updateVerse, 50);
    versify(function(result) { 
        if (updateIntervalId)
            clearInterval(updateIntervalId);
        verse.innerHTML = result;
        verseCache['title=' + title] = result;
    });
}

var title         = document.getElementById('title');
var verse         = document.getElementById('verse');
var another       = document.getElementById('another');
var anothertitle  = document.getElementById('anothertitle');
var composetitled = document.getElementById('composetitled');

if (location.hash === '')
    location.replace(document.URL + '#title=' + randomTitle());  // XXX need to encode anything?
// XXX apparently it's not adding to the history? check this...
// XXX also #Top is a special case so I should prefix to avoid it

another.onclick = function() {
    pushTitle(randomTitle());
    return false;
};

composetitled.onclick = function() {
    pushTitle(anothertitle.value);
    return false;
};

setTitle(getTitle());

};
  </script>

</head>
<body>

  <h1><span id="title">A sonnet</span></h1>
  <p id="verse"><span style="font-size: smaller">[Excuse me a moment while I invoke the muse...]</div>

  <p><br><input id="another" type="submit" value="Give me another">
  <p><form><input id="composetitled" type="submit" value="Compose a sonnet titled:">
    <input id="anothertitle" type="text" size="30"></form>
  <hr>

  <div class="footer">
    <a href="http://github.com/darius/amphigory">Source code</a> on
    GitHub. Also I commend
    <a href="http://books.google.com/books?id=kWElP9YZkzQC&pg=PA43&lpg=PA43&dq=trurl%27s+electronic+bard">Trurl's
      Electronic Bard</a> to your attention.

    <p><em>Copyright &#169; 2012
        <a href="http://wry.me/blog/">Darius Bacon</a><br/></em>
  </div>

  <script src="pronounce_iamb_compat.js"></script>
  <script src="verse.js"></script>
</body></html>
