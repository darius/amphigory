<html><head>
  <title>A sonnet</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href='http://fonts.googleapis.com/css?family=Lusitana:400,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
body { 
    margin: 5em 7em;
    font-family: 'Lusitana', serif;
    font-size: 110%;
}
  </style>
</head><body>
  <h1><span id="title">A sonnet</span></h1>
  <p id="verse"><span style="font-size: smaller">[Excuse me a moment while I invoke the muse...]</div>
  <p><br><input id="another" type="submit" value="Give me any old sonnet">
  <p><form><input id="composetitled" type="submit" value="Compose a sonnet titled:">
    <input id="anothertitle" type="text" size="30"></form>
  <hr>
  <div id="footer" style="font-size: smaller">
  <a href="http://github.com/darius/amphigory">Source code</a> on
  GitHub. Also I commend
  <a href="http://books.google.com/books?id=kWElP9YZkzQC&pg=PA43&lpg=PA43&dq=trurl%27s+electronic+bard">Trurl's
  Electronic Bard</a> to your attention.

  <p><em>Copyright &#169; 2012
  <a href="http://wry.me/blog/">Darius Bacon</a><br/></em></div>

  <script src="pronounce_iamb_compat.js"></script>
  <script src="seedrandom.js"></script>
  <script src="verse.js"></script>
  <script type="text/javascript">
'use strict';

function decodeParams(url) {
    var result = {};
    var qmark = url.indexOf('?');
    if (0 <= qmark) {
        var pairs = url.substring(qmark+1, url.length).split('&');
        for (var i = 0; i < pairs.length; ++i) {
	    var kv = pairs[i].split('=', 2);
	    result[decodeURIComponent(kv[0])] = decodeURIComponent(kv[1]);
        }
    }
    return result;
}

var title         = document.getElementById('title');
var output        = document.getElementById('verse');
var another       = document.getElementById('another');
var anothertitle  = document.getElementById('anothertitle');
var composetitled = document.getElementById('composetitled');

function setTitle(text) {
    title.replaceChild(document.createTextNode(text),
                       title.firstChild);
    Math.seedrandom(text);
}

var params = decodeParams(document.URL);
if (params.title) setTitle(params.title);

var updateIntervalId;

function updateVerse() {
    output.innerHTML = emit(states);
}

function invokeTheMuse(title) {
    if (updateIntervalId) clearInterval(updateIntervalId);
    if (title) setTitle(title);
    updateIntervalId = setInterval(updateVerse, 50);
    versify(function(result) { 
        if (updateIntervalId) clearInterval(updateIntervalId);
        output.innerHTML = result;
    });
}
invokeTheMuse(null);

function randomTitle() {
    return 'Sonnet ' + numberWithCommas(pickInt(Math.pow(2, 48)));
}

// http://stackoverflow.com/questions/2901102/how-to-print-number-with-commas-as-thousands-separators-in-javascript
function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

another.onclick = function() {
    Math.seedrandom(new Date().getTime());
    invokeTheMuse(randomTitle());
    return false;
};

composetitled.onclick = function() {
    invokeTheMuse(anothertitle.value);
    return false;
};
  </script>

</body></html>
